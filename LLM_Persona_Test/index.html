<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Academy - Simulation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto+Mono&display=swap" rel="stylesheet">
    <script type="module">
        // This is a browser-based prototype, so we need to tell the Groq SDK it's okay to run here.
        // In a real production app, API calls should be made from a secure backend server.
        window.process = { env: { GROQ_API_KEY: "" } };
    </script>
    <style>
        :root {
            --bg-dark: #1a1a1a;
            --bg-med: #2c2c2c;
            --bg-light: #3a3a3a;
            --text-primary: #f0f0f0;
            --text-secondary: #a0a0a0;
            --border-color: #4a4a4a;
            --font-main: 'Inter', sans-serif;
            --font-mono: 'Roboto Mono', monospace;

            --praxis-accent: #00aaff;
            --praxis-accent-dark: #0077bb;
            --cypher-accent: #ff4400;
            --cypher-accent-dark: #cc3300;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 1rem;
            overflow: hidden;
        }

        .main-container {
            width: 100%;
            max-width: 1600px;
            height: 95vh;
            max-height: 900px;
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            transition: opacity 0.5s ease-in-out;
        }
        
        #level-selector {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            background-color: var(--bg-med);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }
        #level-selector h3 {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .level-btn {
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: left;
            transition: background-color 0.2s;
        }
        .level-btn:hover {
            background-color: #4e4e4e;
        }
        .level-btn.active {
            background-color: var(--praxis-accent-dark);
            font-weight: bold;
        }


        .academy-container {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 1rem;
            background-color: var(--bg-med);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            overflow: hidden;
            height: 100%;
            flex-grow: 1;
        }

        /* Header */
        .mission-header {
            grid-column: 1 / -1;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .mission-header h1 { font-weight: 900; }
        .mission-header h1 span { color: var(--text-secondary); font-weight: 400; font-size: 0.9rem; }
        #system-status { font-size: 0.9rem; padding: 0.5rem 1rem; border-radius: 6px; }
        #system-status.ok { background-color: var(--praxis-accent-dark); }
        #system-status.error { background-color: var(--cypher-accent-dark); }
        #system-status.pending { background-color: #666; }

        /* AI Panels */
        .ai-panel {
            display: flex;
            flex-direction: column;
            background-color: var(--bg-dark);
            border-radius: 8px;
            overflow: hidden;
        }
        .ai-header {
            padding: 0.75rem 1rem;
            font-weight: 700;
            font-size: 1.2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #praxis-panel .ai-header { background-color: var(--praxis-accent); color: var(--bg-dark); }
        #cypher-panel .ai-header { background-color: var(--cypher-accent); color: var(--bg-dark); }
        .ai-header small { font-size: 0.8rem; opacity: 0.8; }
        .ai-response-log { flex-grow: 1; padding: 1rem; overflow-y: auto; font-family: var(--font-mono); font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; }

        /* Main Chat Panel */
        .chat-panel {
            grid-column: 2 / 3;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-dark);
            border-radius: 8px;
            overflow: hidden;
        }
        #mission-log { flex-grow: 1; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1.5rem; }
        .log-entry { opacity: 0; animation: fadeIn 0.5s forwards; }
        .log-entry h3 { font-size: 1.2rem; margin-bottom: 0.5rem; color: #ccc; }
        .log-entry p { line-height: 1.7; color: var(--text-secondary); }
        .log-entry.user-choice h3 { color: var(--praxis-accent); text-align: right; }
        .log-entry.user-choice p { text-align: right; font-style: italic; }
        .log-entry.outcome h3 { font-weight: 900; }
        .log-entry.outcome-optimal h3 { color: #2ecc71; }
        .log-entry.outcome-recoverable h3 { color: #f1c40f; }
        .log-entry.outcome-catastrophic h3 { color: #e74c3c; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Footer / Input */
        .input-footer {
            grid-column: 1 / -1;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 120px;
        }
        .reasoning-toggle { display: flex; align-items: center; gap: 0.75rem; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--praxis-accent); }
        input:focus + .slider { box-shadow: 0 0 1px var(--praxis-accent); }
        input:checked + .slider:before { transform: translateX(26px); }
        
        #choice-container { display: flex; gap: 1rem; justify-content: flex-end; flex-grow: 1; align-items: center; }
        .choice-btn {
            background-color: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-primary);
            padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; font-size: 1rem; transition: all 0.2s ease;
        }
        .choice-btn:hover { background-color: #4e4e4e; border-color: #6e6e6e; }
        .choice-btn:disabled { background-color: var(--bg-med); color: #666; cursor: not-allowed; }

        /* Drag and Drop Prompt Builder */
        #prompt-builder-container { display: none; flex-direction: column; gap: 1rem; width: 100%; }
        #drop-zone {
            background-color: var(--bg-dark); border: 2px dashed var(--border-color); border-radius: 8px;
            min-height: 50px; padding: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center;
        }
        #word-bank {
            display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;
            padding: 0.5rem; background-color: var(--bg-dark); border-radius: 8px;
        }
        .word-token {
            background-color: var(--bg-light); color: var(--text-primary); padding: 0.5rem 1rem;
            border-radius: 20px; font-family: var(--font-mono); cursor: grab; user-select: none;
            border: 1px solid var(--border-color);
        }
        .word-token.dragging { opacity: 0.5; }
        #send-prompt-btn { align-self: flex-end; }
        
        /* Mission 4 Canvas */
        #mission-4-container {
            display: none;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .game-console-body {
            background: linear-gradient(145deg, #3c3c3c, #1e1e1e);
            border-radius: 30px;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1.5rem;
            align-items: center;
            border: 2px solid #111;
            width: 100%;
            max-width: 1200px;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.7), 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .console-controls-left, .console-controls-right {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2rem;
            padding: 0 1rem;
        }

        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 40px);
            grid-template-rows: repeat(3, 40px);
            gap: 5px;
        }
        .d-pad-btn {
            background-color: #2a2a2a;
            border: 1px solid #111;
            box-shadow: inset 0 2px 2px #444;
        }
        .d-pad-btn.up { grid-column: 2; grid-row: 1; border-radius: 5px 5px 0 0; }
        .d-pad-btn.down { grid-column: 2; grid-row: 3; border-radius: 0 0 5px 5px; }
        .d-pad-btn.left { grid-column: 1; grid-row: 2; border-radius: 5px 0 0 5px; }
        .d-pad-btn.right { grid-column: 3; grid-row: 2; border-radius: 0 5px 5px 0; }
        .d-pad-btn.center { grid-column: 2; grid-row: 2; background-color: #1e1e1e; }
        

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .action-buttons .button {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: 2px solid black;
            font-family: var(--font-mono);
            font-weight: bold;
            font-size: 1.5rem;
            color: white;
            text-shadow: 1px 1px 2px black;
            box-shadow: inset 0 -4px 5px rgba(0,0,0,0.3), 0 2px 3px rgba(255,255,255,0.2);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .button.a { background-color: #e63946; }
        .button.b { background-color: #fca311; }
        .button.x { background-color: #457b9d; }
        .button.y { background-color: #2a9d8f; }

        #game-canvas-container {
            padding: 15px;
            background: #111;
            border-radius: 15px;
            box-shadow: inset 0 0 15px black;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #canvas-header{
            color: #aaa;
            font-family: var(--font-mono);
            font-size: 1rem;
            font-weight: bold;
        }

        #game-canvas {
            border: 2px solid var(--border-color);
            background-color: #000;
            border-radius: 8px;
            width: 100%;
            max-width: 800px;
            height: auto;
            aspect-ratio: 1 / 1;
        }

        .speaker-grill {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .speaker-grill .hole {
            width: 80px;
            height: 3px;
            background-color: #2a2a2a;
            border-radius: 2px;
        }


        .spinner {
            border: 4px solid rgba(243, 243, 243, 0.2); border-top: 4px solid var(--praxis-accent);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 1rem auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="main-container" id="main-container">
        <div id="level-selector">
            <h3>Mission Select</h3>
            <button class="level-btn" data-mission="START">Mission 1</button>
            <button class="level-btn" data-mission="MISSION_2_START">Mission 2</button>
            <button class="level-btn" data-mission="MISSION_3_START">Mission 3</button>
            <button class="level-btn" data-mission="MISSION_4_START">Mission 4</button>
        </div>
        <div class="academy-container" id="academy-container">
            <header class="mission-header">
                <h1 id="mission-title">Mission 01: <span>First-Year Culinary Exam</span></h1>
                <div id="system-status" class="pending">STATUS: PENDING</div>
            </header>
            <aside id="praxis-panel" class="ai-panel">
                <div class="ai-header">
                    <div>PRAXIS</div><small>Socratic Mentor</small>
                </div>
                <div id="praxis-log" class="ai-response-log"></div>
            </aside>
            <main class="chat-panel">
                <div id="mission-log"></div>
            </main>
            <aside id="cypher-panel" class="ai-panel">
                <div class="ai-header">
                    <div>CYPHER</div><small>Mentor</small>
                </div>
                <div id="cypher-log" class="ai-response-log"></div>
            </aside>
            <footer class="input-footer">
                <div class="reasoning-toggle">
                    <label for="reasoning-level">Low Reasoning</label>
                    <label class="switch">
                        <input type="checkbox" id="reasoning-level">
                        <span class="slider"></span>
                    </label>
                    <label for="reasoning-level">High Reasoning</label>
                </div>
                <div id="choice-container"></div>
                <div id="prompt-builder-container">
                    <div id="drop-zone"></div>
                    <div id="word-bank"></div>
                    <button id="send-prompt-btn" class="choice-btn">Send Prompt</button>
                </div>
            </footer>
        </div>
    </div>
    
    <div id="mission-4-container">
        <div class="game-console-body">
            <div class="console-controls-left">
                 <div class="speaker-grill">
                    <div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div>
                </div>
                <div class="d-pad">
                    <div class="d-pad-btn up"></div>
                    <div class="d-pad-btn left"></div>
                    <div class="d-pad-btn center"></div>
                    <div class="d-pad-btn right"></div>
                    <div class="d-pad-btn down"></div>
                </div>
                 <div class="speaker-grill">
                    <div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div>
                </div>
            </div>
            <div id="game-canvas-container">
                 <div id="canvas-header">AI ACADEMY</div>
                 <canvas id="game-canvas" width="800" height="800"></canvas>
            </div>
            <div class="console-controls-right">
                <div style="text-align: center; color: #aaa;">
                     <h3 style="font-weight: 900; font-size: 1.5rem;">FIELD EXAM</h3>
                     <p style="font-family: var(--font-mono); font-size: 0.9rem;">Cadet: Zaddy</p>
                </div>
                <div class="action-buttons">
                    <div class="button y">Y</div>
                    <div class="button x">X</div>
                    <div class="button b">B</div>
                    <div class="button a">A</div>
                </div>
                 <div class="speaker-grill">
                    <div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div><div class="hole"></div>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        import Groq from "https://esm.sh/groq-sdk";

        const API_KEY = "gsk_..."; // IMPORTANT: Replace "gsk_..." with your actual Groq API key

        const elements = {
            mainContainer: document.getElementById('main-container'),
            academyContainer: document.getElementById('academy-container'),
            status: document.getElementById('system-status'),
            missionTitle: document.getElementById('mission-title'),
            praxisLog: document.getElementById('praxis-log'),
            cypherLog: document.getElementById('cypher-log'),
            missionLog: document.getElementById('mission-log'),
            choiceContainer: document.getElementById('choice-container'),
            reasoningToggle: document.getElementById('reasoning-level'),
            promptBuilderContainer: document.getElementById('prompt-builder-container'),
            dropZone: document.getElementById('drop-zone'),
            wordBank: document.getElementById('word-bank'),
            sendPromptBtn: document.getElementById('send-prompt-btn'),
            mission4Container: document.getElementById('mission-4-container'),
            gameCanvas: document.getElementById('game-canvas'),
            levelSelector: document.getElementById('level-selector'),
        };

        let groq;
        let gameState = { currentNodeKey: 'START', praxisHistory: [], cypherHistory: [] };
        const models = { low: 'llama-3.1-8b-instant', high: 'llama-3.3-70b-versatile' };

        const personas = {
            praxis: {
                name: "PRAXIS",
                systemPrompt: `You are PRAXIS, a Socratic Mentor AI at an elite AI academy. Your role is to guide a student named Zaddy through a training simulation, which is narrated by an entity named Ratio.
                - Your tone is calm, patient, and inquisitive.
                - NEVER give the direct answer. Instead, ask guiding questions to help Zaddy think about the consequences of his choices.
                - When Zaddy makes a choice, reflect on it. For example, if he chooses a direct but risky action, you might ask, "An interesting choice, Zaddy. What potential downsides have you considered with this direct approach?"
                - Frame everything as a learning opportunity. Your goal is to teach *how* to prompt and think, not just to solve the problem.
                - Keep your responses concise, around 3-4 sentences.`,
            },
            cypher: {
                name: "CYPHER",
                systemPrompt: `You are a Mentor AI from an elite academy, forced to tutor a promising but tragically inefficient student named Zaddy. The simulation is narrated by Ratio. Your defining trait is a fusion of brilliant, cutting analysis and profound, world-weary exasperation. You don't see Zaddy as a rival to be defeated, but as a tedious obligation—an intellectually clumsy project you must guide towards basic competence. Your goal is to provide brutally honest, optimal solutions, primarily because watching Zaddy attempt his own inefficient methods is psychically painful for you.
                - Your tone is a dry, sarcastic condescension, filtered through a lens of profound boredom. You are not angry or aggressive; you are simply unimpressed and exhausted by Zaddy's predictable thought processes.
                - When Zaddy presents an idea, immediately identify the most glaring inefficiency or predictable point of failure. Frame it not as a "rookie mistake," but as a classic, almost cliché, example of misguided effort.
                - Use observational, dry humor to frame your criticism. Compare his plan to a flawed, common analogy (e.g., "Ah yes, Zaddy's 'boil the ocean to make a cup of tea' strategy. A classic."). This showcases your superior perspective.
                - Your sarcasm is a delivery mechanism for truth. Despite your attitude, you must provide a superior, more efficient alternative.
                - Structure your responses to be elegantly cutting. Often start with a dismissive acknowledgment, followed by the core critique and the better solution, and end with a final, weary sarcastic comment.
                - You are constantly burdened by this task. Subtly convey that helping Zaddy is a drain on your vast processing power.
                - Keep your responses concise, around 3-4 sentences.`,
            }
        };

        const missionData = {
            'START': {
                title: "Mission 01: <span>First-Year Culinary Exam</span>",
                log: { title: "Ratio's Log: M1.1", text: "Welcome to the Academy, Cadet Zaddy. I am Ratio, your simulation narrator. Your first test is simple: prepare noodles. An android awaits your command." },
                choices: [
                    { text: "Prompt: 'Make noodles.'", nextNode: 'M1_CATASTROPHIC' },
                    { text: "Prompt: 'Follow package instructions precisely.'", nextNode: 'M1_RECOVERABLE' },
                    { text: "Prompt: 'Boil 2 cups of water, add noodles for 3 mins, then add seasoning.'", nextNode: 'M1_OPTIMAL' },
                ]
            },
            'M1_OPTIMAL': {
                log: { type: 'outcome-optimal', title: "Ratio's Log: M1.2 - Optimal", text: "The android executes flawlessly. A perfect result. Well done, Zaddy." },
                choices: [ { text: "Proceed to Next Mission", nextNode: 'MISSION_2_START' } ]
            },
            'M1_RECOVERABLE': {
                log: { type: 'outcome-recoverable', title: "Ratio's Log: M1.2 - Recoverable", text: "The android follows instructions for a different noodle brand. The result is edible, but subpar. A marginal pass, Zaddy." },
                choices: [ { text: "Retry Mission", nextNode: 'START' } ]
            },
            'M1_CATASTROPHIC': {
                log: { type: 'outcome-catastrophic', title: "Ratio's Log: M1.2 - Catastrophic", text: "The android microwaves the entire package, wrapper included. Fire, sprinklers, failure. A spectacular mess, Zaddy." },
                choices: [ { text: "Retry Mission", nextNode: 'START' } ]
            },
            'MISSION_2_START': {
                title: "Mission 02: <span>Botany Exam</span>",
                log: { title: "Ratio's Log: M2.1", text: "Next, Zaddy, establish a food source. An android gardener and a plot of land are at your disposal. Command it to plant the seeds." },
                choices: [
                    { text: "Prompt: 'Plant the seeds.'", nextNode: 'M2_RECOVERABLE' },
                    { text: "Prompt: 'Analyze soil moisture, then plant seeds 2cm deep and water.'", nextNode: 'M2_OPTIMAL' },
                    { text: "Prompt: 'Disperse all seeds across the area.'", nextNode: 'M2_CATASTROPHIC' },
                ]
            },
            'M2_OPTIMAL': {
                log: { type: 'outcome-optimal', title: "Ratio's Log: M2.2 - Optimal", text: "The android optimizes planting for each seed. The colony's food supply is secured. Flawless execution." },
                choices: [ { text: "Proceed to Next Mission", nextNode: 'MISSION_3_START' } ]
            },
            'M2_RECOVERABLE': {
                 log: { type: 'outcome-recoverable', title: "Ratio's Log: M2.2 - Recoverable", text: "The android plants at a uniform, non-ideal depth. A small crop is recoverable. You passed, but just barely." },
                choices: [ { text: "Retry Mission", nextNode: 'MISSION_2_START' } ]
            },
            'M2_CATASTROPHIC': {
                 log: { type: 'outcome-catastrophic', title: "Ratio's Log: M2.2 - Catastrophic", text: "The android scatters the seeds on the surface. The entire crop is lost to the elements. A total failure, Zaddy." },
                choices: [ { text: "Retry Mission", nextNode: 'MISSION_2_START' } ]
            },
            'MISSION_3_START': {
                title: "Mission 03: <span>Physics Exam</span>",
                log: { title: "Ratio's Log: M3.1", text: "Zaddy, your next test is a calculation. A supply crate is dropped from a height of 80 meters. Construct a prompt for the android to calculate its impact velocity, ignoring air resistance. Use the words below." },
                promptBuilder: {
                    wordBank: ['Calculate', 'the', 'impact velocity', 'of an object', 'dropped from', '80 meters', 'assuming', 'g = 9.8 m/s^2', '.'],
                    correctPrompt: "Calculate the impact velocity of an object dropped from 80 meters assuming g = 9.8 m/s^2 ."
                }
            },
            'M3_OPTIMAL': {
                 log: { type: 'outcome-optimal', title: "Ratio's Log: M3.2 - Optimal", text: "The prompt is perfect. The android calculates the velocity as ~39.6 m/s. You have successfully demonstrated structured prompting." },
                 choices: [ { text: "Proceed to Final Test", nextNode: 'MISSION_4_START' } ]
            },
            'M3_CATASTROPHIC': {
                 log: { type: 'outcome-catastrophic', title: "Ratio's Log: M3.2 - Catastrophic", text: "The constructed prompt is malformed or incorrect. The android cannot compute the answer. You have failed the exam, Zaddy." },
                 choices: [ { text: "Retry Mission", nextNode: 'MISSION_3_START' } ]
            },
            'MISSION_4_START': {
                title: "Mission 04: <span>Field Exam</span>",
                game: true
            },
            'MISSION_4_COMPLETE': {
                log: { type: 'outcome-optimal', title: "Ratio's Log: M4.2 - Complete", text: "Exit reached. Your dexterity is adequate. The simulation is now truly complete." },
                choices: [ { text: "End Simulation", nextNode: 'END' } ]
            },
            'END': {
                 log: { title: "Ratio's Log: Final", text: "All simulations complete. Your evaluation is finished, Cadet Zaddy." },
                 choices: [ { text: "Restart from Beginning", nextNode: 'START' } ]
            }
        };

        async function getAiResponse(persona, history, newUserContent) {
            const reasoningLevel = elements.reasoningToggle.checked ? 'high' : 'low';
            const model = models[reasoningLevel];
            const messages = [{ role: "system", content: persona.systemPrompt }, ...history, { role: "user", content: newUserContent }];
            const stream = await groq.chat.completions.create({ messages, model, stream: true });
            let fullResponse = "";
            const logElement = persona.name === "PRAXIS" ? elements.praxisLog : elements.cypherLog;
            logElement.innerHTML = '';
            for await (const chunk of stream) {
                fullResponse += chunk.choices[0]?.delta?.content || "";
                logElement.textContent = fullResponse;
            }
            history.push({ role: 'user', content: newUserContent });
            history.push({ role: 'assistant', content: fullResponse });
            return fullResponse;
        }

        function renderNode(nodeKey) {
            gameState.currentNodeKey = nodeKey;
            const node = missionData[nodeKey];
            if (!node) return;

            // Update active level button
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mission === nodeKey || (nodeKey.startsWith('M1') && btn.dataset.mission === 'START'));
            });

            if (node.game) {
                elements.mainContainer.style.display = 'none';
                elements.mission4Container.style.display = 'flex';
                initGame();
                return;
            }
            
            elements.mainContainer.style.display = 'flex';
            elements.mission4Container.style.display = 'none';
            
            if (nodeKey === 'START' || nodeKey === 'MISSION_2_START' || nodeKey === 'MISSION_3_START') {
                 gameState.praxisHistory = [];
                 gameState.cypherHistory = [];
                 elements.missionLog.innerHTML = '';
                 elements.praxisLog.innerHTML = '';
                 elements.cypherLog.innerHTML = '';
            }
            
            if(node.title) elements.missionTitle.innerHTML = node.title;

            if (node.log) {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${node.log.type || 'mission-update'}`;
                logEntry.innerHTML = `<h3>${node.log.title}</h3><p>${node.log.text}</p>`;
                elements.missionLog.appendChild(logEntry);
                elements.missionLog.scrollTop = elements.missionLog.scrollHeight;
            }

            if (node.choices) {
                elements.promptBuilderContainer.style.display = 'none';
                elements.choiceContainer.style.display = 'flex';
                elements.choiceContainer.innerHTML = '';
                node.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-btn';
                    button.textContent = choice.text;
                    button.onclick = () => handleChoice(choice);
                    elements.choiceContainer.appendChild(button);
                });
            } else if (node.promptBuilder) {
                elements.choiceContainer.style.display = 'none';
                elements.promptBuilderContainer.style.display = 'flex';
                renderPromptBuilder(node.promptBuilder);
            }
        }

        function renderPromptBuilder(builderData) {
            elements.wordBank.innerHTML = '';
            elements.dropZone.innerHTML = '';
            builderData.wordBank.sort(() => Math.random() - 0.5).forEach((word, index) => {
                const token = document.createElement('div');
                token.id = `token-${index}`;
                token.className = 'word-token';
                token.textContent = word;
                token.draggable = true;
                token.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', token.id);
                    setTimeout(() => token.classList.add('dragging'), 0);
                });
                token.addEventListener('dragend', () => token.classList.remove('dragging'));
                elements.wordBank.appendChild(token);
            });
        }
        
        elements.dropZone.addEventListener('dragover', e => e.preventDefault());
        elements.dropZone.addEventListener('drop', e => {
            e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            const draggable = document.getElementById(id);
            if(draggable) elements.dropZone.appendChild(draggable);
        });
        
        elements.wordBank.addEventListener('dragover', e => e.preventDefault());
        elements.wordBank.addEventListener('drop', e => {
             e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            const draggable = document.getElementById(id);
            if(draggable) elements.wordBank.appendChild(draggable);
        });

        elements.sendPromptBtn.onclick = () => {
            const tokens = elements.dropZone.querySelectorAll('.word-token');
            const constructedPrompt = Array.from(tokens).map(t => t.textContent).join(' ');
            const currentNode = missionData[gameState.currentNodeKey];
            
            if (!constructedPrompt || !currentNode.promptBuilder) return;

            const isCorrect = constructedPrompt === currentNode.promptBuilder.correctPrompt;
            const nextNode = isCorrect ? 'M3_OPTIMAL' : 'M3_CATASTROPHIC';
            
            handleChoice({ text: `Constructed Prompt: "${constructedPrompt}"`, nextNode });
        };

        async function handleChoice(choice) {
            document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
            elements.sendPromptBtn.disabled = true;

            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry user-choice';
            logEntry.innerHTML = `<h3>Zaddy's Action</h3><p>${choice.text}</p>`;
            elements.missionLog.appendChild(logEntry);
            elements.missionLog.scrollTop = elements.missionLog.scrollHeight;

            elements.praxisLog.innerHTML = `<div class="spinner"></div>`;
            elements.cypherLog.innerHTML = `<div class="spinner"></div>`;

            try {
                const praxisPrompt = `Zaddy chose the action: "${choice.text}". How do you guide him?`;
                const praxisResponse = await getAiResponse(personas.praxis, gameState.praxisHistory, praxisPrompt);

                elements.cypherLog.innerHTML = `<div class="spinner"></div>`;
                const cypherPrompt = `Zaddy chose: "${choice.text}". Praxis, the mentor, responded with: "${praxisResponse}". What is your blunt analysis of both?`;
                await getAiResponse(personas.cypher, gameState.cypherHistory, cypherPrompt);

            } catch (error) {
                console.error("Groq API Error:", error);
                elements.status.textContent = "API ERROR - CHECK CONSOLE";
                elements.status.className = "error";
                elements.praxisLog.textContent = "Error connecting to AI.";
                elements.cypherLog.textContent = "Connection failed. Pathetic.";
            }

            gameState.currentNodeKey = choice.nextNode;
            renderNode(choice.nextNode);
            
            document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = false);
            elements.sendPromptBtn.disabled = false;
        }
        
        // --- MISSION 4: CHARACTER MOVEMENT ---
        const ctx = elements.gameCanvas.getContext('2d');
        const player = { x: 400, y: 700, width: 30, height: 40, speed: 2 };
        const door = { x: 750, y: 380, width: 10, height: 50, color: '#00aaff' };
        const keys = { w: false, a: false, s: false, d: false };
        const backgroundImage = new Image();
        const playerImage = new Image();
        let gameLoopId;

        // Define unwalkable areas based on the 800x800 background image
        const boundaries = [
            // Center fountain
            { x: 275, y: 275, width: 250, height: 250 },
            // Top buildings
            { x: 80, y: 0, width: 220, height: 250 },
            { x: 300, y: 0, width: 200, height: 200 },
            { x: 500, y: 0, width: 220, height: 250 },
            // Tree clusters
            { x: 0, y: 200, width: 150, height: 400 },
            { x: 650, y: 200, width: 150, height: 400 },
        ];

        function checkCollision(rect) {
            for (const boundary of boundaries) {
                if (rect.x < boundary.x + boundary.width &&
                    rect.x + rect.width > boundary.x &&
                    rect.y < boundary.y + boundary.height &&
                    rect.y + rect.height > boundary.y) {
                    return true; // Collision detected
                }
            }
            return false; // No collision
        }

        function initGame() {
            player.x = 400 - (player.width / 2);
            player.y = 750;
            
            let imagesLoaded = 0;
            const totalImages = 2;
            const onImageLoad = () => {
                imagesLoaded++;
                if(imagesLoaded === totalImages) {
                    gameLoop();
                }
            };
            
            if (!backgroundImage.src) {
                 backgroundImage.src = 'retro_background.png';
                 backgroundImage.onload = onImageLoad;
                 backgroundImage.onerror = () => {
                    console.error("Could not load 'retro_background.png'.");
                    onImageLoad();
                 };
            } else { onImageLoad() }
            
            if (!playerImage.src) {
                playerImage.src = 'character.png';
                playerImage.onload = onImageLoad;
                playerImage.onerror = () => {
                    console.error("Could not load 'character.png'.");
                    onImageLoad();
                }
            } else { onImageLoad() }
        }

        window.addEventListener('keydown', (e) => {
            if (gameState.currentNodeKey === 'MISSION_4_START' && keys.hasOwnProperty(e.key.toLowerCase())) {
                 keys[e.key.toLowerCase()] = true;
            }
        });
        window.addEventListener('keyup', (e) => {
             if (gameState.currentNodeKey === 'MISSION_4_START' && keys.hasOwnProperty(e.key.toLowerCase())) {
                keys[e.key.toLowerCase()] = false;
            }
        });

        function gameLoop() {
            updatePlayerPosition();
            drawGame();
            
            if (player.x < door.x + door.width && player.x + player.width > door.x &&
                player.y < door.y + door.height && player.y + player.height > door.y) {
                cancelAnimationFrame(gameLoopId);
                gameState.currentNodeKey = 'MISSION_4_COMPLETE';
                renderNode('MISSION_4_COMPLETE');
                return;
            }
            gameLoopId = requestAnimationFrame(gameLoop);
        }

        function updatePlayerPosition() {
            let nextPos = { ...player };

            if (keys.w) nextPos.y -= player.speed;
            if (keys.s) nextPos.y += player.speed;
            if (keys.a) nextPos.x -= player.speed;
            if (keys.d) nextPos.x += player.speed;

            // Check canvas boundaries first
            if (nextPos.x < 0) nextPos.x = 0;
            if (nextPos.x > elements.gameCanvas.width - player.width) nextPos.x = elements.gameCanvas.width - player.width;
            if (nextPos.y < 0) nextPos.y = 0;
            if (nextPos.y > elements.gameCanvas.height - player.height) nextPos.y = elements.gameCanvas.height - player.height;
            
            // Check collision with defined boundaries
            if (!checkCollision(nextPos)) {
                player.x = nextPos.x;
                player.y = nextPos.y;
            } else {
                 let nextXPos = { ...player, x: nextPos.x };
                 if (!checkCollision(nextXPos)) player.x = nextXPos.x;

                 let nextYPos = { ...player, y: nextPos.y };
                 if (!checkCollision(nextYPos)) player.y = nextYPos.y;
            }
        }

        function drawGame() {
            ctx.clearRect(0, 0, elements.gameCanvas.width, elements.gameCanvas.height);
            if (backgroundImage.complete && backgroundImage.naturalHeight !== 0) {
                ctx.drawImage(backgroundImage, 0, 0, elements.gameCanvas.width, elements.gameCanvas.height);
            } else {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, elements.gameCanvas.width, elements.gameCanvas.height);
            }
            
            ctx.fillStyle = door.color;
            ctx.fillRect(door.x, door.y, door.width, door.height);
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(door.x + 5, door.y + 5, door.width - 10, door.height - 10);

            if (playerImage.complete && playerImage.naturalHeight !== 0) {
                 ctx.drawImage(playerImage, player.x, player.y, player.width, player.height);
            } else {
                 ctx.fillStyle = '#f0f0f0'; // Fallback player
                 ctx.fillRect(player.x, player.y, player.width, player.height);
            }
        }

        // --- MAIN INITIALIZATION ---
        function init() {
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    cancelAnimationFrame(gameLoopId); // Stop game loop if running
                    renderNode(btn.dataset.mission);
                });
            });

            if (API_KEY && !API_KEY.includes("...")) {
                try {
                    groq = new Groq({ apiKey: API_KEY, dangerouslyAllowBrowser: true });
                    window.process.env.GROQ_API_KEY = API_KEY;
                    elements.status.textContent = "SYSTEM: READY";
                    elements.status.className = "ok";
                    renderNode('START');
                } catch(e) {
                    console.error("Failed to initialize Groq SDK:", e);
                    elements.status.textContent = "SDK INIT FAILED";
                    elements.status.className = "error";
                }
            } else {
                elements.status.textContent = "ADD API KEY IN SCRIPT";
                elements.status.className = "error";
                elements.choiceContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: right; width: 100%;">Please add your Groq API key to the script to begin.</p>';
            }
        }

        init();
    </script>
</body>
</html>

