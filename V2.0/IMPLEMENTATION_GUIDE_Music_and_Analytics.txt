================================================================================
AI BEHAVIOR LAB - IMPLEMENTATION GUIDE
Background Music + Player Analytics/Logging
================================================================================

Generated: 2025-11-11
Project: AI Behavior Lab V2.0
Files Affected: start_level.html, ecology_level.html


================================================================================
TABLE OF CONTENTS
================================================================================

1. PROJECT OVERVIEW & TECH STACK
2. CURRENT STATE ANALYSIS
3. FEATURE 1: BACKGROUND MUSIC IMPLEMENTATION
4. FEATURE 2: PLAYER ANALYTICS/LOGGING IMPLEMENTATION
5. DATA STRUCTURES & STORAGE
6. NETLIFY COMPATIBILITY
7. EFFORT ESTIMATES & RECOMMENDATIONS


================================================================================
1. PROJECT OVERVIEW & TECH STACK
================================================================================

MAIN GAME FILES (V2.0):
- start_level.html - Tutorial and Level 1 (Academy Courtyard) - 1,747 lines
- ecology_level.html - Level 2 (Bio-Dome & Ecology School) - 1,757 lines
- Both are self-contained HTML files with embedded JavaScript

ARCHITECTURE:
- Framework: Pure JavaScript (no external frameworks like Vue/React)
- Rendering: HTML5 Canvas (1536x1024 resolution)
- Game Loop: RequestAnimationFrame-based with deltaTime calculations
- State Management: Single centralized gameState object
- Backend: Netlify serverless functions for AI API calls
- Data Persistence: Browser localStorage (indexed-db compatible)

KEY JAVASCRIPT LIBRARIES/APIs USED:
- Web Audio API (available but NOT currently used)
- Canvas 2D API for all rendering
- Fetch API for server communication
- localStorage for game saves
- requestAnimationFrame for game loop

GAME STATE MACHINE:
start_level.html:
  gameMode: 'startScreen' â†’ 'transitionToTutorial' â†’ 'tutorial'
          â†’ 'transitionToLevel1' â†’ 'level1'

ecology_level.html:
  gameMode: 'bioDomeMain' â†’ 'workbench' â†’ 'terraVault'


================================================================================
2. CURRENT STATE ANALYSIS
================================================================================

AUDIO IMPLEMENTATION:
Status: NO AUDIO CURRENTLY IMPLEMENTED
- No music, sound effects, or audio references found in either HTML file
- Game is completely silent
- Web Audio API available but unused

ANALYTICS/LOGGING:
Status: NO DEDICATED ANALYTICS SYSTEM

What exists currently:
- localStorage saves (meMyselfAiSave_v5, ecologyLevelSave_v1)
- Dialogue history stored in gameState:
  - gameState.tutorialState.dialogueHistory[]
  - gameState.level1State.dialogueHistory[]
  - gameState.ecologyState.dialogueHistory[]
- Simple tracking variables:
  - Player inventory (Level 1: brain chip, language chip, emotion chip)
  - Mistakes counter (Level 2: 0-2)
  - Cooldown tracking (Level 2: 12-hour lockout)
  - Completion status flags

CURRENT DATA PERSISTENCE:
- localStorage keys:
  - meMyselfAiSave_v5 (start_level game state)
  - ecologyLevelSave_v1 (ecology_level game state)
- 5MB limit per origin
- Automatic saves every 180 seconds (3 minutes)


================================================================================
3. FEATURE 1: BACKGROUND MUSIC IMPLEMENTATION
================================================================================

DIFFICULTY: EASY (2-3 hours work)
RISK: VERY LOW

-------------------------------------------------------------------------------
STEP 1: ACQUIRE AUDIO FILES
-------------------------------------------------------------------------------

Create/obtain retro-style music files:
- tutorial_music.mp3/.ogg (looping, 1-3 minutes)
- ecology_music.mp3/.ogg (looping, 1-3 minutes)
- Recommendations: Chiptune/8-bit style, synthwave, or ambient retro
- File size: Keep under 2-3MB each (important for Netlify)

Place in folder structure:
- assets/start/tutorial_music.mp3
- assets/level1_ecology/ecology_music.mp3


-------------------------------------------------------------------------------
STEP 2: ADD AUDIO MANAGER CODE
-------------------------------------------------------------------------------

Add this code in BOTH HTML files after canvas setup (~line 130 in start_level,
~line 104 in ecology_level):

```javascript
// ============================================================================
// AUDIO MANAGER
// ============================================================================
const audioManager = {
  tutorialMusic: null,
  ecologyMusic: null,
  currentTrack: null,

  init() {
    this.tutorialMusic = new Audio('assets/start/tutorial_music.mp3');
    this.tutorialMusic.loop = true;
    this.tutorialMusic.volume = 0.3; // 30% volume

    this.ecologyMusic = new Audio('assets/level1_ecology/ecology_music.mp3');
    this.ecologyMusic.loop = true;
    this.ecologyMusic.volume = 0.3;
  },

  playTutorial() {
    if (this.currentTrack === this.tutorialMusic) return;
    this.stopAll();
    this.tutorialMusic.currentTime = 0;
    this.tutorialMusic.play().catch(e => console.log("Audio playback failed:", e));
    this.currentTrack = this.tutorialMusic;
  },

  playEcology() {
    if (this.currentTrack === this.ecologyMusic) return;
    this.stopAll();
    this.ecologyMusic.currentTime = 0;
    this.ecologyMusic.play().catch(e => console.log("Audio playback failed:", e));
    this.currentTrack = this.ecologyMusic;
  },

  stopAll() {
    this.tutorialMusic?.pause();
    this.ecologyMusic?.pause();
  },

  setVolume(level) {
    if (this.tutorialMusic) this.tutorialMusic.volume = level;
    if (this.ecologyMusic) this.ecologyMusic.volume = level;
  }
};
```


-------------------------------------------------------------------------------
STEP 3: INITIALIZE AUDIO IN init() FUNCTION
-------------------------------------------------------------------------------

In the init() function (~line 1638 in start_level, ~line 1714 in ecology_level),
add at the top:

```javascript
function init() {
  audioManager.init(); // ADD THIS LINE
  loadGame();
  // ... rest of init ...
}
```


-------------------------------------------------------------------------------
STEP 4: TRIGGER MUSIC IN GAME LOOP
-------------------------------------------------------------------------------

For start_level.html, in the update() function add:

```javascript
function update(deltaTime) {
  // ... existing code ...

  // Audio management
  if (gameMode === 'tutorial' || gameMode === 'level1') {
    audioManager.playTutorial();
  } else if (gameMode === 'startScreen') {
    audioManager.stopAll(); // Or play separate intro music
  }

  // ... rest of update ...
}
```

For ecology_level.html, in the update() function add:

```javascript
function update(deltaTime) {
  // ... existing code ...

  // Audio management
  if (gameMode === 'bioDomeMain' || gameMode === 'workbench' || gameMode === 'terraVault') {
    audioManager.playEcology();
  }

  // ... rest of update ...
}
```


-------------------------------------------------------------------------------
STEP 5: OPTIONAL - ADD VOLUME CONTROL UI
-------------------------------------------------------------------------------

Add to HTML before closing game-controls div:

```html
<div style="margin-top: 0.5rem;">
  <label for="volume-slider" style="font-size: 0.8rem; margin-right: 0.5rem;">Volume:</label>
  <input type="range" id="volume-slider" min="0" max="100" value="30" style="width: 100px;">
</div>
```

Add event listener in init() or event listeners section:

```javascript
document.getElementById('volume-slider').addEventListener('input', (e) => {
  audioManager.setVolume(e.target.value / 100);
});
```


-------------------------------------------------------------------------------
NETLIFY COMPATIBILITY
-------------------------------------------------------------------------------

âœ“ Perfect - Static audio files deploy like any other asset
âœ“ Place in assets/ folder
âœ“ No serverless function needed
âœ“ No bandwidth concerns for typical traffic

BROWSER COMPATIBILITY:
âœ“ Excellent - HTML5 Audio supported by all modern browsers
âš  One gotcha: Autoplay policies require user interaction first
  (click "Start" button handles this automatically)

RISK ASSESSMENT:
âœ“ Audio runs independently of game logic
âœ“ No changes to existing game state, collision detection, or rendering
âœ“ If audio fails to load, game continues silently (graceful degradation)


================================================================================
4. FEATURE 2: PLAYER ANALYTICS/LOGGING IMPLEMENTATION
================================================================================

DIFFICULTY: MEDIUM (8-12 hours work)
RISK: MEDIUM-LOW


-------------------------------------------------------------------------------
WHAT TO TRACK
-------------------------------------------------------------------------------

LEVEL COMPLETION METRICS:
- Total time to complete tutorial
- Total time to complete Level 1
- Total time to complete Ecology level
- Session duration

STRUGGLE POINT DETECTION:
- Failed resonance tuning attempts (Level 1 mini-game)
- Incorrect ecology prompt submissions (Level 2)
- Dialogue choices that lead to dead ends
- Time spent in each area (bioDome vs workbench vs terraVault)
- Number of times player talks to same NPC
- Player movement patterns (helps identify confusing navigation)

INTERACTION TRACKING:
- Which NPCs players interact with most
- Dialogue option selections
- Order of completing objectives
- Inventory acquisition timeline


-------------------------------------------------------------------------------
STEP 1: ADD ANALYTICS MANAGER CODE
-------------------------------------------------------------------------------

Add this code in BOTH HTML files after gameState definition (~line 150 in
start_level, ~line 120 in ecology_level):

```javascript
// ============================================================================
// ANALYTICS MANAGER
// ============================================================================
const analytics = {
  sessionId: `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
  startTime: Date.now(),
  events: [],

  // Event tracking functions
  logEvent(eventType, eventData = {}) {
    const event = {
      timestamp: Date.now(),
      timeFromStart: Date.now() - this.startTime,
      sessionId: this.sessionId,
      eventType,
      gameMode: gameState.gameMode,
      playerPosition: { x: gameState.player.x, y: gameState.player.y },
      ...eventData
    };

    this.events.push(event);
    console.log(`[ANALYTICS] ${eventType}:`, event);

    // Auto-save every 10 events
    if (this.events.length % 10 === 0) {
      this.saveEvents();
    }
  },

  logPlayerMovement(direction) {
    this.logEvent('PLAYER_MOVED', { direction });
  },

  logInteraction(objectId, objectName) {
    this.logEvent('INTERACTION', { objectId, objectName });
  },

  logDialogueStart(speaker, text) {
    this.logEvent('DIALOGUE_START', { speaker, textLength: text.length });
  },

  logDialogueChoice(speaker, chosenOption, index) {
    this.logEvent('DIALOGUE_CHOICE', { speaker, chosenOption, optionIndex: index });
  },

  logMiniGameStart(gameType) {
    this.logEvent('MINIGAME_START', { gameType });
  },

  logMiniGameComplete(gameType, success, data = {}) {
    this.logEvent('MINIGAME_COMPLETE', { gameType, success, ...data });
  },

  logInventoryChange(itemId, acquired) {
    this.logEvent('INVENTORY_CHANGE', { itemId, acquired });
  },

  logLevelComplete(levelName) {
    this.logEvent('LEVEL_COMPLETE', { levelName, totalTime: Date.now() - this.startTime });
  },

  logMistake(mistakeType, context = {}) {
    this.logEvent('MISTAKE', { mistakeType, ...context });
  },

  saveEvents() {
    try {
      // Save to localStorage (with rotation - keep last 500 events)
      let savedEvents = JSON.parse(localStorage.getItem('analyticsEvents') || '[]');
      savedEvents = savedEvents.concat(this.events).slice(-500);
      localStorage.setItem('analyticsEvents', JSON.stringify(savedEvents));
      console.log(`Saved ${this.events.length} events to localStorage`);
    } catch (error) {
      console.error('Failed to save analytics:', error);
    }
  },

  exportAnalytics() {
    return {
      sessionId: this.sessionId,
      startTime: this.startTime,
      endTime: Date.now(),
      totalDuration: Date.now() - this.startTime,
      totalEvents: this.events.length,
      events: this.events
    };
  }
};
```


-------------------------------------------------------------------------------
STEP 2: HOOK ANALYTICS INTO EXISTING FUNCTIONS
-------------------------------------------------------------------------------

FILE: start_level.html

In handleInteraction() (~line 572):
```javascript
function handleInteraction() {
  const { nearbyObject, activeDialogue } = gameState;
  if (!nearbyObject || activeDialogue.isActive) return;

  analytics.logInteraction(nearbyObject.id, nearbyObject.name); // ADD THIS

  const { id } = nearbyObject;
  // ... rest of existing code ...
}
```

In startDialogue() (~line 414):
```javascript
function startDialogue(speaker, text, options = []) {
  analytics.logDialogueStart(speaker, text); // ADD THIS

  const { activeDialogue } = gameState;
  activeDialogue.isActive = true;
  // ... rest of existing code ...
}
```

In handleKeyDown() (~line 749), dialogue option selection:
```javascript
} else if (key === 'e' || key === 'enter') {
  if (activeDialogue.charIndex < activeDialogue.text.length) {
    activeDialogue.charIndex = activeDialogue.text.length;
  } else if (activeDialogue.options.length > 0) {
    const chosenOption = activeDialogue.options[activeDialogue.selectedOption];
    analytics.logDialogueChoice(activeDialogue.speaker, chosenOption.text, activeDialogue.selectedOption); // ADD THIS
    chosenOption.action();
  } else {
    closeDialogue();
  }
}
```

In startResonanceTuning() (~line 449):
```javascript
function startResonanceTuning(pieceType) {
  analytics.logMiniGameStart(`RESONANCE_${pieceType}`); // ADD THIS

  const pattern = resonancePatterns[pieceType];
  // ... rest of existing code ...
}
```

In endResonanceTuning() (~line 449):
```javascript
function endResonanceTuning(success) {
  const { resonanceState } = gameState;

  analytics.logMiniGameComplete(`RESONANCE_${resonanceState.currentPiece}`, success, {
    successCount: resonanceState.successCount,
    requiredSuccess: resonanceState.requiredSuccess
  }); // ADD THIS

  if (success) {
    // ... existing code ...
    level1State.inventory[resonanceState.currentPiece] = true;
    analytics.logInventoryChange(resonanceState.currentPiece, true); // ADD THIS
  }
  // ... rest of existing code ...
}
```

In Level 1 completion (Gary fixed dialogue):
```javascript
case 3:
  startDialogue("GARY", "I... understand. Thank you, friend. The Academy grounds are yours to explore. I shall be here if you need assistance.", [{ text: "Continue", action: () => {
    level1State.garyFixed = true;
    level1State.garyAnimationState = 'wakingUp';
    level1State.levelComplete = true;
    analytics.logLevelComplete('LEVEL_1'); // ADD THIS
    saveGame();
    closeDialogue();
  }}]);
  break;
```


FILE: ecology_level.html

In handleInteraction() (~line 400):
```javascript
function handleInteraction() {
  const { nearbyObject, activeDialogue } = gameState;
  if (!nearbyObject || activeDialogue.isActive) return;

  analytics.logInteraction(nearbyObject.id, nearbyObject.name); // ADD THIS

  const { id } = nearbyObject;
  // ... rest of existing code ...
}
```

In startDialogue() (~line 323):
```javascript
function startDialogue(speaker, text, options = []) {
  analytics.logDialogueStart(speaker, text); // ADD THIS

  const { activeDialogue } = gameState;
  activeDialogue.isActive = true;
  // ... rest of existing code ...
}
```

In submitPrompt() (~line 653):
```javascript
function submitPrompt() {
  const { ecologyState } = gameState;
  const { first, second } = ecologyState.selectedWords;

  if (!first || !second) {
    startDialogue("Ratio", "Fill in BOTH blanks before submitting, genius.");
    return;
  }

  if (first === 'soil' && second === 'water') {
    analytics.logMiniGameComplete('ECOLOGY_PROMPT', true, {
      firstWord: first,
      secondWord: second
    }); // ADD THIS

    ecologyState.bioBotMood = 'happy';
    // ... rest of existing code ...
  } else {
    analytics.logMistake('ECOLOGY_PROMPT', {
      userAnswer: `${first}|${second}`,
      mistakeCount: ecologyState.mistakes
    }); // ADD THIS
    // ... rest of existing code ...
  }
}
```


-------------------------------------------------------------------------------
STEP 3: ADD EXPORT FUNCTIONALITY
-------------------------------------------------------------------------------

Add to HTML game-controls section:

```html
<button id="export-analytics-button" class="control-button">Export Analytics</button>
```

Add event listener in init() or event listeners section:

```javascript
document.getElementById('export-analytics-button').addEventListener('click', () => {
  const data = analytics.exportAnalytics();
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `analytics_${data.sessionId}.json`;
  a.click();
  URL.revokeObjectURL(url);
  console.log('Analytics exported:', data);
});
```


-------------------------------------------------------------------------------
STEP 4: INTEGRATE WITH SAVE SYSTEM
-------------------------------------------------------------------------------

Modify saveGame() function to also save analytics:

```javascript
function saveGame() {
  try {
    localStorage.setItem('meMyselfAiSave_v5', JSON.stringify(gameState));
    analytics.saveEvents(); // ADD THIS
    showSaveFeedback('Game Saved!');
  } catch (error) {
    console.error("Could not save game:", error);
  }
}
```


-------------------------------------------------------------------------------
STEP 5: OPTIONAL - BACKEND INTEGRATION
-------------------------------------------------------------------------------

For automated data collection, add to analytics object:

```javascript
async sendToBackend() {
  try {
    const response = await fetch('/.netlify/functions/save-analytics', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(this.exportAnalytics())
    });

    if (response.ok) {
      console.log('Analytics sent to server');
    }
  } catch (error) {
    console.error('Failed to send analytics:', error);
  }
},
```

Call in saveGame():

```javascript
function saveGame() {
  try {
    localStorage.setItem('meMyselfAiSave_v5', JSON.stringify(gameState));
    analytics.saveEvents();
    // analytics.sendToBackend(); // Uncomment when backend ready
    showSaveFeedback('Game Saved!');
  } catch (error) { console.error("Could not save game:", error); }
}
```

Create Netlify function: netlify/functions/save-analytics.js

```javascript
const { MongoClient } = require('mongodb');

exports.handler = async (event) => {
  if (event.httpMethod !== 'POST') {
    return { statusCode: 405, body: 'Method Not Allowed' };
  }

  try {
    const data = JSON.parse(event.body);

    // Connect to database
    const client = await MongoClient.connect(process.env.MONGODB_URI);
    const db = client.db('ai-behavior-lab');
    const collection = db.collection('analytics');

    // Insert analytics data
    await collection.insertOne({
      ...data,
      receivedAt: new Date()
    });

    await client.close();

    return {
      statusCode: 200,
      body: JSON.stringify({ success: true })
    };
  } catch (error) {
    console.error('Analytics save error:', error);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: 'Failed to save analytics' })
    };
  }
};
```

Add to .env (not committed to git):
```
MONGODB_URI=mongodb+srv://username:password@cluster.mongodb.net/
```


-------------------------------------------------------------------------------
DATA STORAGE OPTIONS
-------------------------------------------------------------------------------

OPTION A: localStorage Only (EASIEST)
âœ“ No backend needed
âœ“ Works offline
âœ“ Instant setup
âœ— Data stuck on user's browser
âœ— 5MB limit (holds ~50,000 events)
âœ— Can't aggregate across players

OPTION B: localStorage + Manual Export (GOOD MIDDLE GROUND)
âœ“ No backend needed
âœ“ Add "Export Analytics" button
âœ“ Downloads JSON file
âœ“ You manually review/aggregate data
âœ— Requires players to send you files (unlikely to happen)

OPTION C: localStorage + Netlify Function (BEST FOR REAL ANALYTICS)
âœ“ Automatic data collection
âœ“ Aggregate across all players
âœ“ Real-time dashboards possible
âœ“ You already have Netlify functions setup!
âœ— Need database (MongoDB/Firebase/Supabase)
âœ— Additional costs if traffic grows
âœ— Privacy considerations (GDPR, etc.)


-------------------------------------------------------------------------------
DATABASE CHOICES (FOR OPTION C)
-------------------------------------------------------------------------------

MongoDB Atlas:
- Free tier: 512MB storage
- Easy integration with Netlify Functions
- NoSQL - flexible schema
- Best for: Unstructured event data

Supabase:
- Free tier: 500MB storage
- PostgreSQL - structured data
- Real-time subscriptions available
- Best for: Relational analytics queries

Firebase Firestore:
- Free tier: 1GB storage
- Real-time database
- Good SDK support
- Best for: Real-time dashboards


================================================================================
5. DATA STRUCTURES & STORAGE
================================================================================

-------------------------------------------------------------------------------
ANALYTICS EVENT STRUCTURE
-------------------------------------------------------------------------------

```json
{
  "timestamp": 1699876543210,
  "timeFromStart": 45000,
  "sessionId": "session_1699876498210_abc123",
  "eventType": "DIALOGUE_CHOICE",
  "gameMode": "level1",
  "playerPosition": { "x": 400, "y": 300 },
  "speaker": "Ratio",
  "chosenOption": "Ask about the library",
  "optionIndex": 1
}
```


-------------------------------------------------------------------------------
EXISTING DIALOGUE HISTORY FORMAT
-------------------------------------------------------------------------------

```javascript
dialogueHistory: [
  { role: 'user', content: 'prompt sent to AI' },
  { role: 'assistant', content: 'AI response' },
  { role: 'user', content: 'next prompt' }
]
```


-------------------------------------------------------------------------------
INVENTORY FORMAT (LEVEL 1)
-------------------------------------------------------------------------------

```javascript
inventory: {
  cog: false,
  loom: false,
  chip: false
}
```


-------------------------------------------------------------------------------
RESONANCE STATE (MINI-GAME)
-------------------------------------------------------------------------------

```javascript
resonanceState: {
  isActive: false,
  currentPiece: null,
  pattern: ['w', 'a', 's', 'd'],
  currentIndex: 0,
  successCount: 0,
  requiredSuccess: 4,
  syncProgress: 0,
  feedbackTimer: 0
}
```


-------------------------------------------------------------------------------
ECOLOGY STATE (LEVEL 2)
-------------------------------------------------------------------------------

```javascript
ecologyState: {
  mistakes: 0,
  maxMistakes: 2,
  bioBotMood: 'neutral',
  selectedWords: { first: null, second: null },
  promptComplete: false,
  lastSubmitTime: null
}
```


================================================================================
6. NETLIFY COMPATIBILITY
================================================================================

EXISTING NETLIFY FUNCTIONS:
- getRatioDialogue.js - AI dialogue for Ratio character
- getGaryDialogue.js - AI dialogue for Gary character

BACKGROUND MUSIC:
âœ“ Static files in assets/ folder
âœ“ No function needed
âœ“ Deploys automatically with site
âœ“ No bandwidth concerns

ANALYTICS:
âœ“ Can add save-analytics.js function
âœ“ 125K requests/month on free tier (plenty for playtesting)
âœ“ Works with existing serverless architecture
âœ“ Environment variables supported


================================================================================
7. EFFORT ESTIMATES & RECOMMENDATIONS
================================================================================

-------------------------------------------------------------------------------
EFFORT SUMMARY
-------------------------------------------------------------------------------

| Task                              | Difficulty  | Time       | Lines of Code | Risk   |
|-----------------------------------|-------------|------------|---------------|--------|
| Background Music                  | Easy        | 2-3 hours  | ~80 per file  | Low    |
| Analytics (localStorage only)     | Medium      | 6-8 hours  | ~250 per file | Low    |
| Analytics (with backend)          | Medium-Hard | 10-15 hrs  | ~300 + backend| Medium |

COMBINED IMPLEMENTATION:
- Music + Basic Analytics: ~12-15 hours
- Music + Full Backend Analytics: ~18-20 hours


-------------------------------------------------------------------------------
RECOMMENDED IMPLEMENTATION PHASES
-------------------------------------------------------------------------------

PHASE 1: Quick Wins (Week 1)
1. Add background music (retro chiptune loops)
2. Add basic analytics with localStorage export button
3. Test with 5-10 playtesters

PHASE 2: Iterate (Week 2)
4. Review exported analytics manually
5. Identify top 3 struggle points
6. Decide if backend worth it based on data quality needs

PHASE 3: Scale (Optional)
7. Add Netlify function + MongoDB if you want automated collection
8. Build simple dashboard to view aggregated data


-------------------------------------------------------------------------------
WHAT YOU'LL LEARN FROM ANALYTICS
-------------------------------------------------------------------------------

COMPLETION TIMES:
Tutorial: avg 5-8 minutes (expected)
Level 1: avg 12-18 minutes (expected)
Ecology: avg 10-15 minutes (expected)

STRUGGLE DETECTION EXAMPLES:
- "80% of players fail resonance tuning 3+ times"
  â†’ Tutorial needs clarity

- "Players talk to Ratio 5 times before finding workbench"
  â†’ Add visual cue

- "60% get ecology prompt wrong first try"
  â†’ Dialogue hints too vague

- "Average 3 minutes wandering before finding Gary"
  â†’ Navigation unclear

PLAYER BEHAVIOR INSIGHTS:
- Most common dialogue path
- Which NPCs are ignored
- Whether players read all dialogue vs skip
- Movement patterns (do they explore or beeline objectives?)


-------------------------------------------------------------------------------
KEY FILES TO MODIFY
-------------------------------------------------------------------------------

FOR start_level.html (1,747 lines):
- Add audioManager around line 130
- Add analytics around line 150
- Hook into handleInteraction() ~line 572
- Hook into startDialogue() ~line 414
- Hook into handleKeyDown() ~line 749
- Hook into endResonanceTuning() ~line 449
- Hook into init() ~line 1638

FOR ecology_level.html (1,757 lines):
- Add audioManager around line 104
- Add analytics around line 120
- Hook into submitPrompt() ~line 653
- Hook into handleInteraction() ~line 400
- Hook into startDialogue() ~line 323
- Hook into init() ~line 1714


-------------------------------------------------------------------------------
RISK ASSESSMENT
-------------------------------------------------------------------------------

BACKGROUND MUSIC:
ðŸŸ¢ VERY LOW RISK
- Audio runs independently of game logic
- No changes to existing game state, collision detection, or rendering
- If audio fails to load, game continues silently (graceful degradation)
- Browser autoplay policies handled by user interaction (start button)

PLAYER ANALYTICS:
ðŸŸ¡ MEDIUM-LOW RISK
- Analytics code is additive only (doesn't modify existing logic)
- Wrapped in try-catch blocks (errors won't crash game)
- localStorage already used successfully in save system
- Main risk: Forgetting to hook into a key event (incomplete data, not breaking)
- Backend integration adds complexity but failures are non-blocking


-------------------------------------------------------------------------------
BROWSER COMPATIBILITY
-------------------------------------------------------------------------------

HTML5 Audio:
âœ“ Chrome, Firefox, Safari, Edge (all modern versions)
âœ“ Mobile browsers (iOS Safari, Chrome Mobile)
âš  Autoplay requires user interaction (handled by start button)

localStorage:
âœ“ All modern browsers
âœ“ 5MB storage limit (sufficient for game saves + analytics)
âœ“ Can be cleared by user (graceful handling needed)

Canvas API:
âœ“ Already in use, no new concerns

Fetch API:
âœ“ Already in use for AI dialogue functions


================================================================================
END OF IMPLEMENTATION GUIDE
================================================================================

NOTES:
- This codebase is well-structured for these additions
- Game state machine makes audio/analytics triggers straightforward
- Existing save system provides foundation for analytics persistence
- Netlify architecture already supports serverless functions

QUESTIONS/ISSUES:
- Open GitHub issue at: https://github.com/anthropics/claude-code/issues
- Project-specific questions: Test implementations locally first

LAST UPDATED: 2025-11-11
